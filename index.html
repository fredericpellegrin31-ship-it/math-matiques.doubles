<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Espace Mathématique - Les Doubles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050a14;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            color: white;
            z-index: 10;
        }
        .hud-container {
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }
        .hud-panel {
            background: rgba(10, 25, 50, 0.8);
            padding: 10px 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            border: 2px solid #3b82f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            pointer-events: auto;
            min-width: 280px;
        }
        .progress-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.5);
            margin-top: 5px;
        }
        #progress-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            transition: width 1s linear;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 10, 20, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            pointer-events: auto;
            text-align: center;
            padding: 20px;
        }
        .hidden { display: none !important; }
        
        .btn-main {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin: 10px;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.95); }

        select {
            background: #1e293b;
            color: white;
            border: 2px solid #3b82f6;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1rem;
            outline: none;
            cursor: pointer;
        }

        #target-display {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 25, 50, 0.85);
            border: 2px solid #3b82f6;
            padding: 10px 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        #target-text { font-size: 0.9rem; color: #93c5fd; display: block; }
        #target-num { font-size: 3rem; font-weight: 900; color: #ffffff; display: block; line-height: 1; }

        #shoot-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: rgba(239, 68, 68, 0.6);
            border: 4px solid #ef4444;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            user-select: none;
        }
        #shoot-btn:active { transform: scale(0.95); background: #ef4444; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-container">
            <div class="hud-panel">
                <div class="flex justify-between w-full text-sm text-blue-300 items-center">
                    <span>SCORE : <span id="score" class="text-white font-bold text-lg">0</span></span>
                    <span>VIES : <span id="lives" class="text-red-400 font-bold text-lg">3</span></span>
                </div>
                <div class="progress-container">
                    <div id="progress-bar"></div>
                </div>
                <button id="home-btn" class="text-xs text-gray-400 underline mt-1 cursor-pointer">Quitter</button>
            </div>
        </div>

        <div id="target-display" class="hidden">
            <span id="target-text">Quel est le double ?</span>
            <span id="target-num">?</span>
        </div>

        <div id="touch-controls" class="hidden">
            <div id="shoot-btn">FEU !</div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="overlay-title" class="text-5xl font-black text-white mb-6 italic uppercase text-center">Les Doubles</h1>
        <p id="overlay-msg" class="text-blue-200 mb-4 text-xl text-center px-4">Calcule le double du nombre affiché !</p>
        
        <div class="flex flex-col items-center">
            <label for="difficulty" class="text-blue-300 mb-2">Choisir la difficulté :</label>
            <select id="difficulty">
                <option value="10">Doubles de 1 à 10</option>
                <option value="20">Doubles de 1 à 20</option>
                <option value="50">Doubles de 1 à 50</option>
            </select>
            <button id="start-btn" class="btn-main">LANCER LA MISSION</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'START';
        let score = 0;
        let lives = 3;
        const totalTime = 120; 
        let timeLeft = 120;
        let timerInterval;
        let targetNum = 0;
        let maxRange = 10;

        // Audio
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'laser') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'explosion_good') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'explosion_bad') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.4);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        }

        const imgShip = new Image(); imgShip.src = 'playerShip1_red.png';
        const imgLaser = new Image(); imgLaser.src = 'laserRed13.png';
        const imgMeteors = [
            'meteorBrown_big1.png', 'meteorBrown_big2.png', 
            'meteorBrown_big3.png', 'meteorBrown_big4.png'
        ].map(src => { const img = new Image(); img.src = src; return img; });

        let ship = { x: 0, y: 0, w: 60, h: 50, speed: 8 };
        const lasers = [];
        const meteors = [];
        const particles = [];
        const floatingTexts = []; 
        const stars = Array.from({length: 80}, () => ({
            x: Math.random(), y: Math.random(), size: Math.random() * 2, speed: Math.random() * 0.5 + 0.1
        }));

        const overlay = document.getElementById('overlay');
        const progressBar = document.getElementById('progress-bar');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const targetNumEl = document.getElementById('target-num');
        const shootBtn = document.getElementById('shoot-btn');
        const targetDisplay = document.getElementById('target-display');
        const touchControls = document.getElementById('touch-controls');
        const difficultySelect = document.getElementById('difficulty');

        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;
        
        function fireLaser() {
            if (gameState !== 'PLAYING') return;
            lasers.push({ x: ship.x + ship.w / 2 - 4, y: ship.y, w: 9, h: 30 });
            playSound('laser');
        }
        
        shootBtn.addEventListener('touchstart', (e) => { e.preventDefault(); fireLaser(); });
        shootBtn.addEventListener('mousedown', fireLaser);
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') fireLaser(); });

        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); moveShipTouch(e.touches[0]); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveShipTouch(e.touches[0]); });

        function moveShipTouch(touch) {
            ship.x = touch.clientX - ship.w / 2;
            ship.y = touch.clientY - ship.h - 50; 
            clampShip();
        }

        function clampShip() {
            if (ship.x < 0) ship.x = 0;
            if (ship.x > canvas.width - ship.w) ship.x = canvas.width - ship.w;
            if (ship.y < 0) ship.y = 0;
            if (ship.y > canvas.height - ship.h) ship.y = canvas.height - ship.h;
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ship.x = canvas.width / 2 - ship.w / 2;
            ship.y = canvas.height - 140;
        }
        window.onresize = resize;
        resize();

        function spawnMeteor() {
            if (gameState !== 'PLAYING') return;
            
            let val;
            const correctDouble = targetNum * 2;
            const prob = Math.random();
            
            if (prob < 0.20) {
                val = correctDouble;
            } 
            else if (prob < 0.90) {
                const dizaine = Math.floor(correctDouble / 10) * 10;
                let attempt = dizaine + Math.floor(Math.random() * 10);
                val = Math.max(0, attempt);
            }
            else {
                val = Math.floor(Math.random() * (maxRange * 2 + 1));
            }

            meteors.push({
                x: Math.random() * (canvas.width - 70),
                y: -100,
                w: 70, h: 70,
                speed: 1.6 + (score / 1000),
                val: val,
                img: imgMeteors[Math.floor(Math.random() * imgMeteors.length)],
                rotation: 0,
                rotSpeed: (Math.random() - 0.5) * 0.15
            });
            setTimeout(spawnMeteor, 1700);
        }

        function generateNewTarget() {
            targetNum = Math.floor(Math.random() * maxRange) + 1;
            targetNumEl.textContent = targetNum;
        }

        function update() {
            if (gameState !== 'PLAYING') return;

            if (keys['ArrowLeft']) ship.x -= ship.speed;
            if (keys['ArrowRight']) ship.x += ship.speed;
            if (keys['ArrowUp']) ship.y -= ship.speed;
            if (keys['ArrowDown']) ship.y += ship.speed;
            clampShip();

            for (let i = lasers.length - 1; i >= 0; i--) {
                lasers[i].y -= 10;
                if (lasers[i].y < -50) lasers.splice(i, 1);
            }

            for (let i = meteors.length - 1; i >= 0; i--) {
                const m = meteors[i];
                m.y += m.speed;
                m.rotation += m.rotSpeed;

                if (ship.x < m.x + m.w && ship.x + ship.w > m.x && ship.y < m.y + m.h && ship.y + ship.h > m.y) {
                    createExplosion(ship.x + ship.w/2, ship.y + ship.h/2, '#ef4444');
                    playSound('explosion_bad');
                    floatingTexts.push({x: ship.x, y: ship.y, text: 'CHOC !', color: '#ef4444', life: 1.5});
                    lives--;
                    livesEl.textContent = lives;
                    meteors.splice(i, 1);
                    if (lives <= 0) endGame("VAISSEAU DÉTRUIT");
                    continue;
                }

                let hit = false;
                for (let j = lasers.length - 1; j >= 0; j--) {
                    const l = lasers[j];
                    if (l.x < m.x + m.w && l.x + l.w > m.x && l.y < m.y + m.h && l.y + l.h > m.y) {
                        if (m.val === targetNum * 2) {
                            score += 10;
                            generateNewTarget();
                            createExplosion(m.x + m.w/2, m.y + m.h/2, '#22c55e');
                            playSound('explosion_good');
                            // Affichage explicite du gain de points
                            floatingTexts.push({x: m.x, y: m.y, text: '+10', color: '#4ade80', life: 1.2});
                        } else {
                            score = Math.max(0, score - 5);
                            createExplosion(m.x + m.w/2, m.y + m.h/2, '#ef4444');
                            playSound('explosion_bad');
                            // Affichage explicite de la perte de points
                            floatingTexts.push({x: m.x, y: m.y, text: '-5', color: '#f87171', life: 1.2});
                        }
                        scoreEl.textContent = score;
                        meteors.splice(i, 1); lasers.splice(j, 1);
                        hit = true; break;
                    }
                }
                if (!hit && m.y > canvas.height) meteors.splice(i, 1);
            }

            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                if (p.life <= 0) particles.splice(i, 1);
            });

            floatingTexts.forEach((t, i) => {
                t.y -= 1.5; t.life -= 0.02;
                if (t.life <= 0) floatingTexts.splice(i, 1);
            });
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 10; i++) {
                particles.push({
                    x, y, 
                    vx: (Math.random() - 0.5) * 8, 
                    vy: (Math.random() - 0.5) * 8, 
                    life: 1, color: color
                });
            }
        }

        function draw() {
            ctx.fillStyle = '#050a14';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            stars.forEach(s => {
                ctx.beginPath();
                ctx.arc(s.x * canvas.width, (s.y * canvas.height + Date.now() * s.speed) % canvas.height, s.size, 0, Math.PI * 2);
                ctx.fill();
            });

            meteors.forEach(m => {
                ctx.save();
                ctx.translate(m.x + m.w / 2, m.y + m.h / 2);
                ctx.rotate(m.rotation);
                ctx.drawImage(m.img, -m.w / 2, -m.h / 2, m.w, m.h);
                ctx.restore();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(m.val, m.x + m.w / 2, m.y + m.h / 2 + 8);
            });

            lasers.forEach(l => ctx.drawImage(imgLaser, l.x, l.y, l.w, l.h));

            if (lives > 0) ctx.drawImage(imgShip, ship.x, ship.y, ship.w, ship.h);

            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
            });

            floatingTexts.forEach(t => {
                ctx.globalAlpha = t.life;
                ctx.fillStyle = t.color;
                ctx.font = "bold 32px Arial"; // Augmentation de la taille pour meilleure lisibilité
                ctx.textAlign = "center";
                ctx.fillText(t.text, t.x + 35, t.y);
            });

            ctx.globalAlpha = 1;
            requestAnimationFrame(() => { update(); draw(); });
        }

        function startGame() {
            maxRange = parseInt(difficultySelect.value);
            score = 0; lives = 3; timeLeft = totalTime;
            scoreEl.textContent = score; livesEl.textContent = lives;
            progressBar.style.width = '100%';
            meteors.length = 0; lasers.length = 0;
            gameState = 'PLAYING';
            overlay.classList.add('hidden');
            targetDisplay.classList.remove('hidden');
            touchControls.classList.remove('hidden');
            generateNewTarget();
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                progressBar.style.width = (timeLeft / totalTime * 100) + '%';
                if (timeLeft <= 0) endGame("MISSION RÉUSSIE");
            }, 1000);
            spawnMeteor();
        }

        function endGame(reason) {
            gameState = 'GAMEOVER';
            clearInterval(timerInterval);
            document.getElementById('overlay-title').textContent = reason;
            document.getElementById('overlay-msg').innerHTML = `Fin de mission !<br><br><b>Score : ${score}</b>`;
            document.getElementById('start-btn').textContent = "RECOMMENCER";
            overlay.classList.remove('hidden');
            targetDisplay.classList.add('hidden');
            touchControls.classList.add('hidden');
        }

        document.getElementById('start-btn').onclick = startGame;
        document.getElementById('home-btn').onclick = () => { if(confirm("Abandonner la mission ?")) location.reload(); };

        draw();
    </script>
</body>
</html>

